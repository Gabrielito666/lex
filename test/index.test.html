<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <!--<div lexid="3">
        <h1 lexid="1"><span lexid="0">numero: </span>0</h1>
        <button lexid="2">Incrementar</button>
    </div>-->
</body>
<script type="module">var __defProp = Object.defineProperty;
var __defProps = Object.defineProperties;
var __getOwnPropDescs = Object.getOwnPropertyDescriptors;
var __getOwnPropSymbols = Object.getOwnPropertySymbols;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __propIsEnum = Object.prototype.propertyIsEnumerable;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __spreadValues = (a, b) => {
  for (var prop in b || (b = {}))
    if (__hasOwnProp.call(b, prop))
      __defNormalProp(a, prop, b[prop]);
  if (__getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(b)) {
      if (__propIsEnum.call(b, prop))
        __defNormalProp(a, prop, b[prop]);
    }
  return a;
};
var __spreadProps = (a, b) => __defProps(a, __getOwnPropDescs(b));

// index.js
var State = class {
  constructor(initValue) {
    this._value = initValue;
    this.onChangesStack = [];
  }
  get() {
    return this._value;
  }
  set(newValue) {
    this._value = newValue;
    this.onChangesStack.forEach((fn) => fn(newValue));
  }
  valueOf() {
    return this._value;
  }
  toString() {
    return String(this._value);
  }
  appendOnChange(fn) {
    if (typeof fn === "function") this.onChangesStack.push(fn);
  }
};
var useState = (initValue) => {
  const state = new State(initValue);
  return [state, (newValue) => {
    state.set(newValue);
  }];
};
var useRef = (initValue) => ({ current: initValue });
var flattenChildren = (children) => {
  const result = [];
  children.forEach((ch) => {
    if (Array.isArray(ch)) {
      result.push(...flattenChildren(ch));
    } else result.push(ch);
  });
  return result;
};
var lexElements = Array.from(document.querySelectorAll("[lexid]"));
var counter = { current: 0 };
var createElement = (tag, props = {}, ...children) => {
  if (!props) props = {};
  props.lexid = counter.current;
  let element;
  let selectMode = false;
  if (lexElements.length > counter.current) {
    element = document.querySelector(`[lexid="${props.lexid}"]`);
    selectMode = true;
  }
  if (typeof tag === "string") {
    if (!selectMode) element = document.createElement(tag);
    Object.entries(props).forEach(([key, value]) => {
      if (key.startsWith("on") && typeof value === "function") {
        element.addEventListener(key.slice(2).toLowerCase(), value);
      } else if (value instanceof State) {
        value.appendOnChange((newValue) => {
          props[key] = newValue;
          element.setAttribute(key, newValue);
        });
      } else if (key === "ref" && value instanceof Object) {
        props.ref.current = element;
      } else {
        element.setAttribute(key, value);
      }
    });
    flattenChildren(children).forEach((ch, i) => {
      if (selectMode) {
        if (ch instanceof State) {
          const textNode = element.childNodes[i];
          ch.appendOnChange((newValue) => {
            textNode.nodeValue = newValue;
          });
        }
      } else {
        if (ch instanceof window.Node) element.appendChild(ch);
        else {
          const textNode = document.createTextNode(String(ch));
          element.appendChild(textNode);
          if (ch instanceof State) {
            ch.appendOnChange((newValue) => {
              textNode.nodeValue = newValue;
            });
          }
        }
      }
    });
    counter.current++;
  } else if (typeof tag === "function") {
    if (!selectMode) element = tag(__spreadProps(__spreadValues({}, props), { children }));
    else tag(__spreadProps(__spreadValues({}, props), { children }));
  }
  return element;
};
var Fragment = ({ children }) => children;
var Lex = { createElement, State, useState, useRef, Fragment };
var index_default = Lex;

// test/lex.test.js
var Counter = () => {
  const [count, setCount] = useState(0);
  const ref = useRef(null);
  const clickHandler = () => {
    setCount(count + 1);
    console.log(ref.current.textContent);
  };
  return /* @__PURE__ */ index_default.createElement("div", null, /* @__PURE__ */ index_default.createElement("h1", { ref }, "numero: ", count), /* @__PURE__ */ index_default.createElement("button", { onClick: clickHandler }, "increment"));
};
var Main = ({ children }) => /* @__PURE__ */ index_default.createElement("main", null, children);
var Counters = () => /* @__PURE__ */ index_default.createElement(index_default.Fragment, null, /* @__PURE__ */ index_default.createElement(Counter, null), /* @__PURE__ */ index_default.createElement(Counter, null), /* @__PURE__ */ index_default.createElement(Counter, null), /* @__PURE__ */ index_default.createElement(Counter, null));
console.log(/* @__PURE__ */ index_default.createElement(Main, null, /* @__PURE__ */ index_default.createElement(Counters, null)));
document.querySelector("body").appendChild(/* @__PURE__ */ index_default.createElement(Main, null, /* @__PURE__ */ index_default.createElement(Counters, null)));
</script>
</html>
